# DNS 

## DNS是什么？
DNS（Domain Name System：域名系统），与 HTTP、FTP 和 SMTP 一样，DNS 协议也是应用层的协议，用于将用户提供的主机名（域名）解析为 IP 地址。

## 域名结构
DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构：
- 根域名服务器（Root DNS Server）：管理顶级域名服务器，返回“com”、“net”、“cn”等顶级域名服务器的 IP 地址
- 顶级域名服务器（Top-level DNS Server）：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址
- 权威域名服务器（Authoritative DNS Server）：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 www.pzijun.cn 的 IP 地址

但如果全世界的域名解析都往这个系统里挤，这个系统可能被挤瘫痪了，即使不瘫痪，解析速度也会大打折扣，所以 DNS 采取了一种非常有效的手段来解决这个问题： **缓存**



## DNS 查询方式
DNS 查询有两种方式：**递归** 和 **迭代** 。

一般来说，DNS 客户端设置使用的 DNS 服务器一般都是 递归服务器 ，它负责全权处理客户端的 DNS 查询请求，直到返回最终结果而 DNS 根域名服务器之间一般采用 迭代查询 方式，以免根域名服务器的压力过大

## DNS 完整查询过程
将我们上面所说的域名服务器之间的 DNS 查询请求过程和域名缓存结合起来，完整查询过程:
1. 首先搜索 **浏览器的 DNS 缓存** ，缓存中维护一张域名与 IP 地址的对应表
2. 如果没有命中😢，则继续搜索 **操作系统的 DNS 缓存**
3. 如果依然没有命中🤦‍♀️，则**操作系统将域名发送至 本地域名服务器 ，本地域名服务器查询自己的 DNS 缓存**，查找成功则返回结果（注意：主机和本地域名服务器之间的查询方式是 **递归查询** ）
4. 若本地域名服务器的 DNS 缓存没有命中🤦‍，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行 **迭代查询** （注意：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大），具体过程如下：
   - 首先本地域名服务器向根域名服务器发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案
   - 本地域名服务器拿到这个顶级域名服务器的地址后，就向其发起请求，获取权限域名服务器的地址
   - 本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址
5. 本地域名服务器 将得到的 IP 地址返回给操作系统，同时自己将 IP 地址 缓存 起来📝
6. 操作系统 将 IP 地址返回给浏览器，同时自己也将 IP 地址 缓存 起来📝
7. 至此， 浏览器 就得到了域名对应的 IP 地址，并将 IP 地址 缓存 起来📝

## DNS 服务器通信协议
DNS 查询在刚设计时主要使用 UDP 协议进行通信，而 TCP 协议也是在 DNS 的演进和发展中被加入到规范的

由于历史的原因，互联网上物理链路的最小 MTU = 576 ，基于 UDP 传输的 DNS 为了限制报文不超过 576 ，所以将 DNS 报文限制在 512 字节。

这样一旦 DNS 查询应答超过 512 字节，基于 UDP 的 DNS 就只有截短为 512 字节，那么用户得到的 DNS 应答就是不完整的。

为了克服这种困难，我们第一次在 DNS 协议中明确了 『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』 这一规范。尽管交易时间可能比较长，但毕竟可以得到完整的答案，总比得到不完整的答案要好。

RFC6891 中引入了 EDNS 机制，它允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的传输数据分片以及丢失（在实际生产中，一旦数据包中的数据超过了传送链路的最大传输单元MTU，当前数据包就可能会被分片传输、丢弃），使得这一特性不够可靠。

## 域名缓存优化
域名缓存有以下两种方式：
- **非权威域名服务器（本地域名服务器）缓存**：各大运营服务商或大公司都有自己的 DNS 服务器，一般部署在距离用户较近地方，代替用户用户访问核心 DNS 系统，可以缓存之前的查询结果，如果已经有了记录，就无需再向根服务器发起查询，直接返回对应的 IP 地址
- **本地计算机 DNS 记录缓存**:
  - **浏览器 DNS 记录缓存**： 浏览器在获取某一网站域名的实际 IP 地址后，进行缓存，之后遇到同一域名查询之前的缓存结果即可，有效减少网络请求的损耗。每种浏览器都有一个固定的 DNS 缓存时间，如 Chrome 的过期时间是 1 分钟，在这个期限内不会重新请求 DNS
  - **操作系统 DNS 记录缓存**：操作系统里有一个特殊的“主机映射”文件，通常是一个可编辑的文本，在 Linux 里是 `/etc/hosts` ，在 Windows 里是 `C:\WINDOWS\system32\drivers\etc\hosts` ，如果操作系统在缓存里找不到 DNS 记录，就会找这个文件


# 参考链接
- [超详细 DNS 协议解析](https://segmentfault.com/a/1190000039039275)
- [为什么 DNS 使用 UDP 协议](https://draveness.me/whys-the-design-dns-udp-tcp/)
- [dns 查询过程，dns 用什么协议发起 dns 查询的](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/502)
