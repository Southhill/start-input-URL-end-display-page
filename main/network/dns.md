# DNS 

## DNS是什么？
DNS（Domain Name System：域名系统），与 HTTP、FTP 和 SMTP 一样，DNS 协议也是应用层的协议，它是 Internet 的基础之一，用于将域名映射到 IP 地址，就像手机电话簿里将人的名字对应到电话号码一样。当我们在浏览器中输入 Web 地址时，就可以通过 DNS 查询将其转换为关联服务器对应的 IP 地址。

> 如果没有 DNS，我们需要记住每个站点的 IP 地址才能访问它。这在互联网刚兴起时，还是可以比较轻松做到的，当时人们可以轻松地将特定 IP 地址与特定计算机相对应，通过在浏览器中直接输入特定的 IP 地址以访问网站。后来，随着越来越多的设备和人们加入到这个不断发展的网络，IP 越来越多，记忆就变成了一项极大的负担，网民都想要一个更易于记忆的单词组成的地址，因此诞生了域名。

## 域名结构
DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构：
- 根域名服务器（Root DNS Server）：管理顶级域名服务器，返回“com”、“net”、“cn”等顶级域名服务器的 IP 地址
- 顶级域名服务器（Top-level DNS Server）：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址
- 权威域名服务器（Authoritative DNS Server）：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 www.pzijun.cn 的 IP 地址

但如果全世界的域名解析都往这个系统里挤，这个系统可能被挤瘫痪了，即使不瘫痪，解析速度也会大打折扣，所以 DNS 采取了一种非常有效的手段来解决这个问题： **缓存**



## DNS 查询方式
DNS 查询有两种方式：**递归** 和 **迭代** 。

一般来说，DNS 客户端设置使用的 DNS 服务器一般都是 递归服务器 ，它负责全权处理客户端的 DNS 查询请求，直到返回最终结果而 DNS 根域名服务器之间一般采用 迭代查询 方式，以免根域名服务器的压力过大

## DNS 完整查询过程
将我们上面所说的域名服务器之间的 DNS 查询请求过程和域名缓存结合起来，完整查询过程:
1. 首先搜索 **浏览器的 DNS 缓存** ，缓存中维护一张域名与 IP 地址的对应表
2. 如果没有命中😢，则继续搜索 **操作系统的 DNS 缓存**
3. 如果依然没有命中🤦‍♀️，则**操作系统将域名发送至 本地域名服务器 ，本地域名服务器查询自己的 DNS 缓存**，查找成功则返回结果（注意：主机和本地域名服务器之间的查询方式是 **递归查询** ）
4. 若本地域名服务器的 DNS 缓存没有命中🤦‍，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行 **迭代查询** （注意：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大），具体过程如下：
   - 首先本地域名服务器向根域名服务器发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案
   - 本地域名服务器拿到这个顶级域名服务器的地址后，就向其发起请求，获取权限域名服务器的地址
   - 本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址
5. 本地域名服务器 将得到的 IP 地址返回给操作系统，同时自己将 IP 地址 缓存 起来📝
6. 操作系统 将 IP 地址返回给浏览器，同时自己也将 IP 地址 缓存 起来📝
7. 至此， 浏览器 就得到了域名对应的 IP 地址，并将 IP 地址 缓存 起来📝

## DNS 服务器通信协议
DNS 查询在刚设计时主要使用 UDP 协议进行通信，而 TCP 协议也是在 DNS 的演进和发展中被加入到规范的

由于历史的原因，互联网上物理链路的最小 MTU = 576 ，基于 UDP 传输的 DNS 为了限制报文不超过 576 ，所以将 DNS 报文限制在 512 字节。

这样一旦 DNS 查询应答超过 512 字节，基于 UDP 的 DNS 就只有截短为 512 字节，那么用户得到的 DNS 应答就是不完整的。

为了克服这种困难，我们第一次在 DNS 协议中明确了 『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』 这一规范。尽管交易时间可能比较长，但毕竟可以得到完整的答案，总比得到不完整的答案要好。

RFC6891 中引入了 EDNS 机制，它允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的传输数据分片以及丢失（在实际生产中，一旦数据包中的数据超过了传送链路的最大传输单元MTU，当前数据包就可能会被分片传输、丢弃），使得这一特性不够可靠。

## 域名缓存优化
域名缓存有以下两种方式：
- **非权威域名服务器（本地域名服务器）缓存**：各大运营服务商或大公司都有自己的 DNS 服务器，一般部署在距离用户较近地方，代替用户用户访问核心 DNS 系统，可以缓存之前的查询结果，如果已经有了记录，就无需再向根服务器发起查询，直接返回对应的 IP 地址
- **本地计算机 DNS 记录缓存**:
  - **浏览器 DNS 记录缓存**： 浏览器在获取某一网站域名的实际 IP 地址后，进行缓存，之后遇到同一域名查询之前的缓存结果即可，有效减少网络请求的损耗。每种浏览器都有一个固定的 DNS 缓存时间，如 Chrome 的过期时间是 1 分钟，在这个期限内不会重新请求 DNS
  - **操作系统 DNS 记录缓存**：操作系统里有一个特殊的“主机映射”文件，通常是一个可编辑的文本，在 Linux 里是 `/etc/hosts` ，在 Windows 里是 `C:\WINDOWS\system32\drivers\etc\hosts` ，如果操作系统在缓存里找不到 DNS 记录，就会找这个文件

## DNS 记录
常见的 DNS 记录有以下几种：
- A 记录：保存域的 IP 地址的记录。
- CNAME 记录：别名，将一个域或子域转发到另一个域，不提供 IP 地址。
- MX 记录：将邮件定向到电子邮件服务器。
- TXT 记录：可使管理员在记录中存储文本注释。
- NS 记录：存储 DNS 条目的名称服务器。
- SOA 记录：存储域的管理信息。
- SRV 记录：指定用于特定服务的端口。
- PTR 记录：在反向查询中提供域名。

其中 A 记录和 CNAME 这两个是解析域名最常用的记录。

## DoH/DoT
DoH （DNS over HTTPS）即使用安全的 HTTPS 协议运行 DNS ，主要目的是增强用户的安全性和隐私性。通过使用加密的 HTTPS 连接，第三方将不再影响或监视解析过程。因此，欺诈者将无法查看请求的 URL 并对其进行更改。如果使用了基于 HTTPS 的 DNS ，数据在传输过程中发生丢失时，DoH 中的传输控制协议（TCP）会做出更快的反应。

 DoH 依赖于 HTTPS，因此也依赖于 TCP，一种在 Internet 上使用频率更高的协议。这样既可以对连接进行加密， TCP 协议也可以确保完整的数据传输。另外，使用了基于 HTTPS 的 DNS，通信始终通过 443 端口进行，并在 443 端口传输实际的网络流量（例如，访问网站）。因此，外人无法区分 DNS 请求和其他通信，这也保障了更高级别的用户隐私。

 DoT(基于 TLS 的 DNS) 使用了安全协议 TLS，在用于 DNS 查询的用户数据报协议（UDP）的基础上添加了 TLS 加密。DoT 使用 853 端口。DoT 具有专用端口，因此即使请求和响应本身都已加密，但具有网络可见性的任何人都可以发现来回的 DoT 流量。

# 参考链接
- [超详细 DNS 协议解析](https://segmentfault.com/a/1190000039039275)
- [为什么 DNS 使用 UDP 协议](https://draveness.me/whys-the-design-dns-udp-tcp/)
- [dns 查询过程，dns 用什么协议发起 dns 查询的](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/502)
- [【白话科普】聊聊 DNS 的那些小知识](https://www.upyun.com/tech/article/624/%E3%80%90%E7%99%BD%E8%AF%9D%E7%A7%91%E6%99%AE%E3%80%91%E8%81%8A%E8%81%8A%20DNS%20%E7%9A%84%E9%82%A3%E4%BA%9B%E5%B0%8F%E7%9F%A5%E8%AF%86.html)
- [告别DNS劫持，一文读懂DoH](https://zhuanlan.zhihu.com/p/365093156)
